apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ include "childAppName" . }}
  namespace: {{ .Values.argoCdNamespace | quote }}
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default

  source:
    repoURL: {{ .Values.application.chartRepoUrl | quote }}
    chart: minio-tenant
    targetRevision: {{ .Values.application.chartVersion | quote }}
    helm:
      releaseName: {{ include "childAppName" . }}
      values: |
      {{- if .Values.application.valuesOverride }}
        {{- .Values.application.valuesOverride | toYaml | nindent 8 }}
      {{- else }}
        tenant:
          name: {{ include "tenantName" . | quote }}
          configSecret:
            name: {{ include "configSecretName" . | quote }}
            {{- with .Values.configSecret.existingSecret }}
            existingSecret: {{ . }}
            {{- end }}
            accessKey: {{ .Values.configSecret.accessKey | quote }}
            secretKey: {{ .Values.configSecret.secretKey | quote }}
          {{- if .Values.application.pools }}
          pools:
            - servers: {{ .Values.servers }}
              name: {{ .Values.poolName | quote }}
              volumesPerServer: {{ .Values.volumesPerServer }}
              size: {{ .Values.size }}
          {{- end }}
          {{- if .Values.backup.enabled }}
          buckets:
            - name: {{ .Values.backup.bucketName | quote }}
          {{- end }}
      {{- end }}

  destination:
    server: https://kubernetes.default.svc
    namespace: {{ .Release.Namespace }}

  {{- with .Values.application.syncPolicy }}
  syncPolicy: {{- . | toYaml | nindent 4 }}
  {{- end }}
